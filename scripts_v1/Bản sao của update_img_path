
import os
import json
import re
from unidecode import unidecode

def fix_image_paths(json_path, image_folder):
    def normalize(text):
        # Chuáº©n hoÃ¡ tiÃªu Ä‘á» bÃ i viáº¿t Ä‘á»ƒ khá»›p vá»›i tÃªn file áº£nh
        text = unidecode(text.lower())
        text = re.sub(r'[^a-z0-9\-]+', '-', text)
        return text.strip('-')

    def extract_slug_from_url(url):
        # TrÃ­ch slug tá»« URL cuá»‘i (bá» .html/.htm)
        filename = url.strip().split('/')[-1]
        return filename.replace('.htm', '').replace('.html', '').strip()

    with open(json_path, 'r', encoding='utf-8') as f:
        data = json.load(f)

    image_files = os.listdir(image_folder)
    updated = 0
    fallback_used = 0
    not_found = []

    for item in data:
        url_slug = extract_slug_from_url(item.get('URL', ''))
        title_slug = normalize(item.get('title', '')) if item.get('title') else ''

        matched_img = None

        # 1ï¸âƒ£ Æ¯u tiÃªn match theo url_slug
        for img in image_files:
            if url_slug and url_slug in img:
                matched_img = img
                break

        # 2ï¸âƒ£ Náº¿u khÃ´ng khá»›p, thá»­ fallback báº±ng title_slug
        if not matched_img and title_slug:
            for img in image_files:
                if title_slug in img:
                    matched_img = img
                    fallback_used += 1
                    break

        # 3ï¸âƒ£ Ghi nháº­n káº¿t quáº£
        if matched_img:
            item['image_path'] = os.path.join(image_folder, matched_img)
            updated += 1
        else:
            not_found.append((url_slug, title_slug))

    # Ghi láº¡i káº¿t quáº£
    with open(json_path, 'w', encoding='utf-8') as f:
        json.dump(data, f, indent=2, ensure_ascii=False)

    # Thá»‘ng kÃª
    print(f"âœ… ÄÃ£ cáº­p nháº­t thÃ nh cÃ´ng {updated} áº£nh trong {json_path}")
    print(f"ğŸ” Trong Ä‘Ã³ cÃ³ {fallback_used} áº£nh Ä‘Æ°á»£c match báº±ng title_slug fallback")
    if not_found:
        print(f"âŒ CÃ²n {len(not_found)} áº£nh khÃ´ng thá»ƒ khá»›p:")
        for url_slug, title_slug in not_found:
            print(f"  - URL Slug: {url_slug}\n    Title Slug: {title_slug}")

# Cháº¡y cho cÃ¡c táº­p dá»¯ liá»‡u
fix_image_paths('dataset/train_custom.json', 'dataset/img_crawl')
fix_image_paths('dataset/test_custom.json', 'dataset/img_crawl')
fix_image_paths('dataset/val_custom.json', 'dataset/img_crawl')
fix_image_paths('dataset/labeled_articles.json', 'dataset/img_crawl')
